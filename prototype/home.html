<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindCapture ‚Äì Low‚ÄëFidelity Prototype</title>
  <style>
    :root {
      --bg: #0f0f23;
      --panel: #1a1a2e;
      --muted: #2a2a4e;
      --ink: #e2e8f0;
      --primary: #60a5fa;
      --accent: #8b5cf6;
      --success: #10b981;
      --warn: #f59e0b;
      --border: #2a2a4e;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--ink); }

    /* App Shell */
    .app {
      display: grid;
      grid-template-columns: 300px 1fr;
      grid-template-rows: 60px 1fr;
      grid-template-areas:
        "sidebar header"
        "sidebar main";
      height: 100vh;
    }
    .sidebar { grid-area: sidebar; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
    .header { grid-area: header; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; }
    .main { grid-area: main; display: flex; flex-direction: column; }

    /* Sidebar */
    .brand { padding: 16px; border-bottom: 1px solid var(--border); }
    .brand .logo { color: var(--primary); font-weight: 700; }

    .capture { padding: 12px 16px; border-bottom: 1px solid var(--border); display: grid; gap: 8px; }
    .textarea { width: 100%; min-height: 80px; background: var(--muted); border: 1px solid #3a3a5e; border-radius: 8px; color: var(--ink); padding: 10px; resize: vertical; font-size: 14px; }
    .btn-row { display: flex; gap: 8px; }
    .btn { background: var(--primary); color: white; border: 0; border-radius: 8px; padding: 8px 12px; font-size: 12px; }
    .btn.alt { background: #374151; }

    .sidebar-section { padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .field { background: var(--muted); border: 1px solid #3a3a5e; border-radius: 8px; color: var(--ink); padding: 8px 10px; width: 100%; font-size: 14px; }
    .list { margin-top: 10px; display: grid; gap: 6px; max-height: 180px; overflow: auto; }
    .list-item { background: var(--muted); border: 1px solid #3a3a5e; border-radius: 8px; padding: 8px 10px; font-size: 13px; opacity: .9; }

    /* Header */
    .tabs { display: flex; gap: 6px; }
    .tab { padding: 8px 10px; border-radius: 8px; background: var(--muted); border: 1px solid #3a3a5e; font-size: 13px; }
    .tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .actions { display: flex; gap: 8px; }

    /* Views */
    .view { flex: 1; display: none; padding: 16px; overflow: auto; }
    .view.active { display: block; }

    /* Mind map mock */
    .canvas { position: relative; height: calc(100vh - 60px - 32px); background: radial-gradient(circle at 50% 50%, #151528 0%, var(--bg) 100%); border: 1px dashed #334155; border-radius: 12px; }
    .node { position: absolute; background: var(--muted); border: 2px solid var(--primary); color: var(--ink); padding: 10px 14px; border-radius: 14px; min-width: 120px; max-width: 240px; font-size: 13px; box-shadow: 0 4px 16px rgba(96,165,250,0.15); }
    .node.task { border-color: var(--warn); }
    .node.knowledge { border-color: var(--success); }
    .node.idea { border-color: var(--accent); }
    .chip { font-size: 10px; opacity: .7; text-transform: uppercase; letter-spacing: .4px; margin-bottom: 4px; display: block; }
    .connect { position: absolute; height: 2px; background: linear-gradient(90deg, var(--primary), var(--accent)); opacity: .5; }

    /* Tasks View Styles (from tasks.html) */
    .page-header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 16px;}
    .title{font-weight:700}
    .filters{display:flex; gap:8px; flex-wrap:wrap}
    .chip-filter{background:var(--muted); border:1px solid #3a3a5e; border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer}
    .chip-filter.active{background:var(--primary); border-color:var(--primary); color:#fff}
    .lanes{display:flex; gap:18px; margin-top:1.5rem;}
    .lane{background:var(--panel); border-radius:16px; padding:1rem .5rem; flex:1; min-width:180px; display:flex; flex-direction:column;}
    .lane-title{font-weight:700; font-size:1.1rem; margin-bottom:.75rem; color:var(--primary); letter-spacing:.5px;}
    .task-list{display:flex; flex-direction:column; gap:10px;}
    .task{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:0; display:flex; align-items:center; gap:10px; transition:opacity .3s, transform .2s; cursor:move;}
    .task[data-status="completed"]{opacity:.5; text-decoration:line-through;}
    .task.hide{display:none !important;}
    .task.dragging{transform:scale(1.05); opacity:0.8; z-index:1000; box-shadow:0 8px 16px rgba(0,0,0,0.3);}
    .lane.drag-over{background:var(--muted); border:2px dashed var(--primary);}
    .badge{font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); opacity:.85}

    /* To-Do View Styles (from todo.html) */
    .board{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;}
    .column{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; display:grid; gap:8px;}
    .column h3{margin:0 0 6px 0; color:var(--primary)}
    .card{background:var(--muted); border:1px solid #3a3a5e; border-radius:10px; padding:10px; font-size:14px}
    @media (max-width:1100px){ .board{grid-template-columns:repeat(2, 1fr);} }
    @media (max-width:700px){ .board{grid-template-columns:1fr;} }


    /* Knowledge */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px; display: grid; gap: 8px; }
    .meta { font-size: 12px; opacity: .7; display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { background: #2f2f50; border: 1px solid #3a3a5e; padding: 2px 8px; border-radius: 999px; font-size: 11px; }

    /* Insights */
    .insight { background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; border-radius: 12px; padding: 12px; box-shadow: 0 8px 28px rgba(0,0,0,.35); }
    .insights-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
    .widget { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }

    /* Floating panel & Modals */
    .floating { position: fixed; right: 16px; bottom: 16px; width: 320px; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px; display: grid; gap: 8px; }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; padding: 16px; }
    .modal { width: 420px; max-width: 100%; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .modal h3 { margin: 0 0 8px 0; }

    /* Responsive */
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; grid-template-rows: 60px auto 1fr; grid-template-areas: "header" "sidebar" "main"; }
      .sidebar { border-right: 0; border-bottom: 1px solid var(--border); }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo">üß† MindCapture</div>
        <div style="font-size:12px;opacity:.7;display:flex;gap:6px;align-items:center;">
          <span id="statusIndicator" style="width:8px;height:8px;border-radius:50%;background:var(--success);"></span>
          <span id="statusText">Online</span>
        </div>
      </div>

      <!-- Capture -->
      <section class="capture">
        <textarea class="textarea" id="quickInput" placeholder="Capture thoughts, tasks, or knowledge..."></textarea>
        <div class="btn-row">
          <button class="btn" onclick="captureInput()">üìù Add</button>
          <button class="btn alt" onclick="voiceCapture()">üéô Voice</button>
          <button class="btn alt" onclick="imageCapture()">üì∑ Image</button>
          <button class="btn alt">üìé Attach</button>
        </div>
        <div style="font-size:11px;opacity:.65;">Auto transcription & inference when online</div>
      </section>
      
      <!-- Folders -->
      <section class="sidebar-section">
        <div style="font-weight:600;margin-bottom:8px;">Folders</div>
        <div class="list">
          <div class="list-item">üìÅ Personal</div>
          <div class="list-item">üìÅ Work</div>
          <div class="list-item">üìÅ Learning</div>
        </div>
      </section>
      
      <!-- Search & History -->
      <section class="sidebar-section">
        <input class="field" placeholder="Search chats, items, folders" />
        <div class="list" aria-label="Recent Chats">
          <div class="list-item">Chat ‚Ä¢ Morning plan</div>
          <div class="list-item">Project ‚Ä¢ PWA research</div>
          <div class="list-item">Topic ‚Ä¢ Learning graph</div>
        </div>
      </section>
    </aside>

    <!-- Header -->
    <header class="header">
      <nav class="tabs" aria-label="Primary">
        <span class="tab active">üó∫Ô∏è Mind Map</span>
        <span class="tab">‚úÖ Tasks</span>
        <span class="tab">üìã To-Do</span>
        <span class="tab">üìö Knowledge</span>
        <span class="tab">üí° Insights</span>
      </nav>
      <div class="actions">
        <button class="tab">üåÖ Briefing</button>
        <button class="tab">üåô Reflection</button>
        <button class="tab">üì§ Export</button>
        <button class="tab">‚ûï Install</button>
      </div>
    </header>

    <!-- Main Views -->
    <main class="main">
      <!-- Mind Map View -->
      <section class="view active" aria-label="Mind Map">
        <div class="canvas" id="mindmapCanvas">
          <!-- Nodes and connections will be rendered dynamically -->
        </div>
      </section>

      <!-- Tasks View -->
      <section class="view" aria-label="Tasks">
        <div class="page-header">
          <h1 class="title">Tasks</h1>
          <div class="filters">
            <button class="chip-filter active" data-filter="all">All</button>
            <button class="chip-filter" data-filter="today">Today</button>
            <button class="chip-filter" data-filter="overdue">Overdue</button>
            <button class="chip-filter" data-filter="completed">Completed</button>
          </div>
        </div>
        <section class="lanes">
          <div class="lane" data-priority="High">
            <div class="lane-title">High</div>
            <div class="task-list">
              <div class="task" draggable="true" data-priority="High" data-status="active" data-date="2025-08-07"><span class="badge">High</span> Turn ideas into to‚Äëdos using AI suggestions</div>
            </div>
          </div>
          <div class="lane" data-priority="Medium">
            <div class="lane-title">Medium</div>
            <div class="task-list">
              <div class="task" draggable="true" data-priority="Medium" data-status="active" data-date="2025-08-07"><span class="badge">Medium</span> Equilibrium engine: detect plan gaps</div>
            </div>
          </div>
          <div class="lane" data-priority="Low">
            <div class="lane-title">Low</div>
            <div class="task-list">
              <div class="task" draggable="true" data-priority="Low" data-status="active" data-date="2025-08-07"><span class="badge">Low</span> 1% Daily Progress visuals</div>
            </div>
          </div>
        </section>
      </section>

      <!-- To-Do View -->
      <section class="view" aria-label="To-Do">
        <h1 style="margin:0 0 16px 0;">To‚ÄëDo Board</h1>
        <section class="board">
          <div class="column">
            <h3>Backlog</h3>
            <div class="card">Explore offline caching strategies</div>
            <div class="card">Draft node clustering rules</div>
          </div>
          <div class="column">
            <h3>In Progress</h3>
            <div class="card">Create UI scaffold</div>
          </div>
          <div class="column">
            <h3>Done</h3>
            <div class="card">Write PRD outline</div>
          </div>
        </section>
      </section>

      <!-- Knowledge View -->
      <section class="view" aria-label="Knowledge">
        <div class="grid">
          <article class="card">
            <div style="font-weight:600;">PWA Offline Guide</div>
            <div class="meta"><span class="tag">PDF</span><span class="tag">Saved</span><span class="tag">Offline</span></div>
            <div style="font-size:13px;opacity:.85;">AI summary placeholder: key takeaways appear here.</div>
          </article>
          <article class="card">
            <div style="font-weight:600;">Graph Search Patterns</div>
            <div class="meta"><span class="tag">Article</span><span class="tag">Knowledge</span></div>
            <div style="font-size:13px;opacity:.85;">Why did you save this? ‚Ä¢ For mind map engine research</div>
          </article>
          <article class="card">
            <div style="font-weight:600;">Topic Cluster ‚Äì Focus</div>
            <div class="meta"><span class="tag">Cluster</span><span class="tag">AI</span></div>
            <div style="font-size:13px;opacity:.85;">Related items and suggested links.</div>
          </article>
        </div>
      </section>

      <!-- Insights View -->
      <section class="view" aria-label="Insights">
        <div class="insights-grid">
          <div class="insight">üí° Suggestion: Convert ‚ÄúPWA research notes‚Äù into 2 actionable tasks.</div>
          <div class="widget">Streak: 4 days ‚Ä¢ 1% Daily Progress</div>
          <div class="widget">Nudge: You started ‚ÄúEquilibrium Engine‚Äù ‚Äî finish scope draft.</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Floating Today Panel -->
  <aside class="floating" id="taskPanel" aria-label="Today‚Äôs Focus" style="display:none;">
    <div style="font-weight:700; color: var(--primary);">Today‚Äôs Focus</div>
    <div id="taskList"></div>
  </aside>

  <!-- Morning Briefing Modal -->
  <div class="modal-backdrop" id="morningPanel" style="display:none;" aria-hidden="true">
    <div class="modal">
      <h3>üåÖ Morning Briefing</h3>
      <p style="opacity:.85;">Here's what's on your plate today:</p>
      <div id="morningTasks"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="tab" onclick="hideMorningBriefing()">Got it</button>
      </div>
    </div>
  </div>

  <!-- Evening Reflection Modal (hidden visual stub) -->
  <div class="modal-backdrop" aria-hidden="true" style="display:none;">
    <div class="modal">
      <h3>üåô Evening Reflection</h3>
      <p style="opacity:.85;">What did you do? What‚Äôs next for tomorrow?</p>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
        <button class="tab">Later</button>
        <button class="tab active">Save</button>
      </div>
    </div>
  </div>

  <script>
    // App State for dynamic mind map and tasks
    let appState = {
      nodes: [],
      connections: [],
      currentView: 'mindmap',
      selectedNode: null,
      isOnline: navigator.onLine,
      offsetX: 0,
      offsetY: 0,
      isDragging: false,
      dragNode: null,
      nodeCounter: 0
    };

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      loadSampleData();
      updateOnlineStatus();
      setActiveView(0);
      document.getElementById('taskPanel').style.display = 'grid';
    });

    function initializeApp() {
      // Online/Offline detection
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);

      // Canvas event listeners
      const canvas = document.getElementById('mindmapCanvas');
      canvas.addEventListener('mousedown', startDrag);
      canvas.addEventListener('mousemove', drag);
      canvas.addEventListener('mouseup', endDrag);
      canvas.addEventListener('contextmenu', showContextMenu);

      // Hide context menu on click
      document.addEventListener('click', hideContextMenu);

      // Tab/view switching
      const tabs = Array.from(document.querySelectorAll('.header .tabs .tab'));
      const views = Array.from(document.querySelectorAll('.main .view'));
      tabs.forEach((tabEl, i) => {
        tabEl.addEventListener('click', () => setActiveView(i));
      });

      // Task Filter Logic
      const chips = document.querySelectorAll('.chip-filter');
      const tasks = document.querySelectorAll('.task');
      chips.forEach(chip => {
        chip.addEventListener('click', () => {
          chips.forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          const filter = chip.getAttribute('data-filter');
          tasks.forEach(task => {
            task.classList.remove('hide');
            if (filter === 'all') {
              task.classList.remove('hide');
            } else if (filter === 'today') {
              const today = new Date().toISOString().slice(0, 10);
              if (task.getAttribute('data-date') !== today) task.classList.add('hide');
            } else if (filter === 'overdue') {
              const today = new Date().toISOString().slice(0, 10);
              const taskDate = task.getAttribute('data-date');
              if (!taskDate || taskDate >= today) task.classList.add('hide');
            } else if (filter === 'completed') {
              if (task.getAttribute('data-status') !== 'completed') task.classList.add('hide');
            }
          });
        });
      });

      // Task Drag and Drop Logic
      initializeTaskDragDrop();

      // Header actions
      const headerActions = Array.from(document.querySelectorAll('.header .actions .tab'));
      const [btnBriefing, btnReflection, btnExport, btnInstall] = headerActions;
      if (btnBriefing) btnBriefing.addEventListener('click', showMorningBriefing);
      if (btnExport) btnExport.addEventListener('click', exportData);
      if (btnInstall) btnInstall.addEventListener('click', () => {
        btnInstall.textContent = '‚úî Installed';
        setTimeout(() => (btnInstall.textContent = '‚ûï Install'), 1200);
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
          switch (e.key) {
            case 'n':
              e.preventDefault();
              document.getElementById('quickInput').focus();
              break;
            case 'e':
              e.preventDefault();
              exportData();
              break;
          }
        }
        // Toggle Today panel with "t"
        if (e.key.toLowerCase() === 't' && !e.ctrlKey && !e.metaKey) {
          const panel = document.getElementById('taskPanel');
          const isHidden = getComputedStyle(panel).display === 'none';
          panel.style.display = isHidden ? 'grid' : 'none';
        }
      });
    }

    function initializeTaskDragDrop() {
      const tasks = document.querySelectorAll('.task[draggable="true"]');
      const lanes = document.querySelectorAll('.lane');

      tasks.forEach(task => {
        task.addEventListener('dragstart', handleTaskDragStart);
        task.addEventListener('dragend', handleTaskDragEnd);
      });

      lanes.forEach(lane => {
        lane.addEventListener('dragover', handleLaneDragOver);
        lane.addEventListener('drop', handleLaneDrop);
        lane.addEventListener('dragenter', handleLaneDragEnter);
        lane.addEventListener('dragleave', handleLaneDragLeave);
      });
    }

    function handleTaskDragStart(e) {
      e.dataTransfer.setData('text/plain', e.target.outerHTML);
      e.dataTransfer.setData('application/task-id', e.target.dataset.priority + '-' + Date.now());
      e.target.classList.add('dragging');
      
      // Store reference to the dragged element
      window.draggedTask = e.target;
    }

    function handleTaskDragEnd(e) {
      e.target.classList.remove('dragging');
      window.draggedTask = null;
    }

    function handleLaneDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }

    function handleLaneDragEnter(e) {
      e.preventDefault();
      if (e.target.classList.contains('lane') || e.target.closest('.lane')) {
        const lane = e.target.closest('.lane') || e.target;
        lane.classList.add('drag-over');
      }
    }

    function handleLaneDragLeave(e) {
      if (e.target.classList.contains('lane') || e.target.closest('.lane')) {
        const lane = e.target.closest('.lane') || e.target;
        // Only remove drag-over if we're actually leaving the lane
        if (!lane.contains(e.relatedTarget)) {
          lane.classList.remove('drag-over');
        }
      }
    }

    function handleLaneDrop(e) {
      e.preventDefault();
      const lane = e.target.closest('.lane') || e.target;
      lane.classList.remove('drag-over');
      
      if (!window.draggedTask) return;
      
      const newPriority = lane.dataset.priority;
      const oldPriority = window.draggedTask.dataset.priority;
      
      if (newPriority !== oldPriority) {
        // Update task priority
        window.draggedTask.dataset.priority = newPriority;
        
        // Update badge text and class
        const badge = window.draggedTask.querySelector('.badge');
        if (badge) {
          badge.textContent = newPriority;
        }
        
        // Move task to new lane
        const taskList = lane.querySelector('.task-list');
        if (taskList) {
          taskList.appendChild(window.draggedTask);
        }
        
        // Show success feedback
        showTaskMoveNotification(oldPriority, newPriority);
        
        // Update task panel if it's visible
        updateTaskPanel();
      }
    }

    function showTaskMoveNotification(oldPriority, newPriority) {
      const notification = document.createElement('div');
      notification.className = 'insight';
      notification.style.position = 'fixed';
      notification.style.top = '80px';
      notification.style.right = '16px';
      notification.style.zIndex = '1000';
      notification.textContent = `‚úÖ Task moved from ${oldPriority} to ${newPriority} priority`;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }

    function updateOnlineStatus() {
      const indicator = document.getElementById('statusIndicator');
      const text = document.getElementById('statusText');
      if (navigator.onLine) {
        indicator.style.background = 'var(--success)';
        text.textContent = 'Online';
        appState.isOnline = true;
        processOfflineQueue();
      } else {
        indicator.style.background = '#ef4444';
        text.textContent = 'Offline';
        appState.isOnline = false;
      }
    }

    function loadSampleData() {
      const sampleNodes = [
        { id: 1, x: 300, y: 200, content: 'Project Ideas', type: 'idea', category: 'central' },
        { id: 2, x: 150, y: 100, content: 'Build PWA for knowledge capture', type: 'task', category: 'project' },
        { id: 3, x: 450, y: 120, content: 'Learn about mind mapping techniques', type: 'knowledge', category: 'learning' },
        { id: 4, x: 200, y: 320, content: 'AI-powered task suggestions', type: 'idea', category: 'feature' },
        { id: 5, x: 400, y: 300, content: 'Offline-first architecture research', type: 'knowledge', category: 'technical' }
      ];
      appState.nodes = sampleNodes;
      appState.nodeCounter = sampleNodes.length;
      renderMindMap();
      updateTaskPanel();
    }

    function captureInput() {
      const input = document.getElementById('quickInput');
      const content = input.value.trim();
      if (!content) return;
      const newNode = {
        id: ++appState.nodeCounter,
        x: Math.random() * 400 + 200,
        y: Math.random() * 300 + 150,
        content: content,
        type: detectInputType(content),
        category: 'user-input',
        timestamp: new Date().toISOString()
      };
      appState.nodes.push(newNode);
      input.value = '';
      renderMindMap();
      updateTaskPanel();
      setTimeout(() => showAISuggestion(newNode), 1000);
    }

    function detectInputType(content) {
      const taskKeywords = ['todo', 'task', 'do', 'remember to', 'need to', 'should', 'must'];
      const knowledgeKeywords = ['learn', 'research', 'study', 'read about', 'understand'];
      const lowerContent = content.toLowerCase();
      if (taskKeywords.some(keyword => lowerContent.includes(keyword))) {
        return 'task';
      } else if (knowledgeKeywords.some(keyword => lowerContent.includes(keyword))) {
        return 'knowledge';
      } else {
        return 'idea';
      }
    }

    function showAISuggestion(node) {
      const suggestion = document.createElement('div');
      suggestion.className = 'insight';
      suggestion.style.position = 'absolute';
      suggestion.style.left = (node.x + 100) + 'px';
      suggestion.style.top = (node.y - 30) + 'px';
      let suggestionText = '';
      switch (node.type) {
        case 'task':
          suggestionText = 'üí° Should this have a due date?';
          break;
        case 'knowledge':
          suggestionText = 'üí° Want to find related resources?';
          break;
        default:
          suggestionText = 'üí° Turn this into an action item?';
      }
      suggestion.textContent = suggestionText;
      document.getElementById('mindmapCanvas').appendChild(suggestion);
      setTimeout(() => {
        if (suggestion.parentNode) {
          suggestion.parentNode.removeChild(suggestion);
        }
      }, 3000);
    }

    function voiceCapture() {
      if (!('webkitSpeechRecognition' in window)) {
        alert('Voice capture not supported in this browser');
        return;
      }
      const recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      recognition.onstart = function() {
        document.getElementById('quickInput').placeholder = 'üéôÔ∏è Listening...';
      };
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('quickInput').value = transcript;
        document.getElementById('quickInput').placeholder = 'Capture thoughts, tasks, or knowledge...';
      };
      recognition.onerror = function() {
        document.getElementById('quickInput').placeholder = 'Voice capture failed. Try again.';
      };
      recognition.start();
    }

    function imageCapture() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const content = `üì∑ Image captured: ${file.name}\n[OCR would extract text here]`;
            document.getElementById('quickInput').value = content;
          };
          reader.readAsDataURL(file);
        }
      };
      input.click();
    }

    function renderMindMap() {
      const canvas = document.getElementById('mindmapCanvas');
      canvas.innerHTML = '';
      // Render connections first
      appState.connections.forEach(conn => {
        const connection = document.createElement('div');
        connection.className = 'connect';
        canvas.appendChild(connection);
      });
      // Render nodes
      appState.nodes.forEach(node => {
        const nodeElement = document.createElement('div');
        nodeElement.className = `node ${node.type}`;
        nodeElement.style.left = node.x + 'px';
        nodeElement.style.top = node.y + 'px';
        nodeElement.dataset.nodeId = node.id;
        nodeElement.innerHTML = `
          <span class="chip">${node.type.charAt(0).toUpperCase() + node.type.slice(1)}</span>
          ${node.content}
        `;
        nodeElement.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          startNodeDrag(e, node);
        });
        nodeElement.addEventListener('click', (e) => {
          e.stopPropagation();
          selectNode(node);
        });
        canvas.appendChild(nodeElement);
      });
    }

    function startNodeDrag(e, node) {
      appState.dragNode = node;
      appState.dragOffsetX = e.clientX - node.x;
      appState.dragOffsetY = e.clientY - node.y;
    }

    function startDrag(e) {
      if (!appState.dragNode) {
        appState.isDragging = true;
        appState.lastX = e.clientX;
        appState.lastY = e.clientY;
      }
    }

    function drag(e) {
      if (appState.dragNode) {
        appState.dragNode.x = e.clientX - appState.dragOffsetX;
        appState.dragNode.y = e.clientY - appState.dragOffsetY;
        renderMindMap();
      } else if (appState.isDragging) {
        const deltaX = e.clientX - appState.lastX;
        const deltaY = e.clientY - appState.lastY;
        appState.nodes.forEach(node => {
          node.x += deltaX;
          node.y += deltaY;
        });
        appState.lastX = e.clientX;
        appState.lastY = e.clientY;
        renderMindMap();
      }
    }

    function endDrag() {
      appState.isDragging = false;
      appState.dragNode = null;
    }

    function selectNode(node) {
      appState.selectedNode = node;
    }

    function showContextMenu(e) {
      e.preventDefault();
      const menu = document.createElement('div');
      menu.className = 'modal';
      menu.style.position = 'fixed';
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
      menu.style.zIndex = 1000;
      menu.innerHTML = `
        <button onclick="contextAction('edit')">‚úèÔ∏è Edit</button>
        <button onclick="contextAction('task')">‚úÖ Make Task</button>
        <button onclick="contextAction('delete')">üóëÔ∏è Delete</button>
      `;
      menu.id = 'contextMenu';
      document.body.appendChild(menu);
    }

    function hideContextMenu() {
      const menu = document.getElementById('contextMenu');
      if (menu) menu.remove();
    }

    function contextAction(action) {
      if (!appState.selectedNode) return;
      switch (action) {
        case 'edit':
          const newContent = prompt('Edit content:', appState.selectedNode.content);
          if (newContent) {
            appState.selectedNode.content = newContent;
            renderMindMap();
          }
          break;
        case 'task':
          appState.selectedNode.type = 'task';
          // Also add to task lanes with medium priority by default
          addTaskToLanes(appState.selectedNode.content, 'Medium');
          renderMindMap();
          updateTaskPanel();
          break;
        case 'delete':
          appState.nodes = appState.nodes.filter(n => n.id !== appState.selectedNode.id);
          renderMindMap();
          updateTaskPanel();
          break;
      }
      hideContextMenu();
    }

    function setActiveView(index) {
      const tabs = Array.from(document.querySelectorAll('.header .tabs .tab'));
      const views = Array.from(document.querySelectorAll('.main .view'));
      tabs.forEach((t, i) => t.classList.toggle('active', i === index));
      views.forEach((v, i) => v.classList.toggle('active', i === index));
      // Show/hide relevant content
      if (index === 1) { // Original Tasks view, now floating panel
        document.getElementById('taskPanel').style.display = 'grid';
      } else {
        document.getElementById('taskPanel').style.display = 'none';
      }
    }

    function updateTaskPanel() {
      // Get tasks from both mind map nodes and DOM task lanes
      const taskNodes = appState.nodes.filter(node => node.type === 'task');
      const domTasks = Array.from(document.querySelectorAll('.lanes .task')).map(taskEl => ({
        content: taskEl.textContent.replace(/^(High|Medium|Low)\s*/, '').trim(),
        priority: taskEl.dataset.priority,
        status: taskEl.dataset.status,
        element: taskEl
      }));
      
      const taskList = document.getElementById('taskList');
      
      // Combine mind map tasks and DOM tasks
      const allTasks = [
        ...taskNodes.map(task => ({
          content: task.content,
          priority: 'Mind Map',
          status: 'active',
          element: null
        })),
        ...domTasks
      ];
      
      taskList.innerHTML = allTasks.map(task => `
        <div class="task" style="border-left: 3px solid ${getPriorityColor(task.priority)};">
          <input type="checkbox" style="margin-right:8px;" ${task.status === 'completed' ? 'checked' : ''}>
          <span style="font-size:12px; opacity:0.7;">[${task.priority}]</span>
          <span>${task.content}</span>
        </div>
      `).join('');
    }

    function getPriorityColor(priority) {
      switch(priority) {
        case 'High': return '#ef4444';
        case 'Medium': return '#f59e0b';
        case 'Low': return '#10b981';
        default: return 'var(--primary)';
      }
    }

    function addTaskToLanes(content, priority = 'Medium') {
      const lane = document.querySelector(`.lane[data-priority="${priority}"]`);
      if (lane) {
        const taskList = lane.querySelector('.task-list');
        const taskElement = document.createElement('div');
        taskElement.className = 'task';
        taskElement.draggable = true;
        taskElement.dataset.priority = priority;
        taskElement.dataset.status = 'active';
        taskElement.dataset.date = new Date().toISOString().slice(0, 10);
        taskElement.innerHTML = `<span class="badge">${priority}</span> ${content}`;
        
        // Add drag event listeners to the new task
        taskElement.addEventListener('dragstart', handleTaskDragStart);
        taskElement.addEventListener('dragend', handleTaskDragEnd);
        
        taskList.appendChild(taskElement);
      }
    }

    function showMorningBriefing() {
      const panel = document.getElementById('morningPanel');
      const taskNodes = appState.nodes.filter(node => node.type === 'task').slice(0, 3);
      const morningTasks = document.getElementById('morningTasks');
      morningTasks.innerHTML = taskNodes.map(task => `‚Ä¢ ${task.content}`).join('<br>');
      panel.style.display = 'flex';
    }

    function hideMorningBriefing() {
      document.getElementById('morningPanel').style.display = 'none';
    }

    function exportData() {
      const data = {
        nodes: appState.nodes,
        connections: appState.connections,
        exportDate: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'mindcapture-export.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function processOfflineQueue() {
      if (appState.isOnline) {
        // Simulate processing offline captured content
        // Here would be the actual sync logic
      }
    }

    // Auto-save (localStorage simulation)
    setInterval(() => {
      localStorage.setItem('mindcapture-data', JSON.stringify(appState));
    }, 5000);

    // Load saved data on startup
    window.addEventListener('load', () => {
      const saved = localStorage.getItem('mindcapture-data');
      if (saved) {
        const data = JSON.parse(saved);
        appState = { ...appState, ...data };
        renderMindMap();
        updateTaskPanel();
      }
    });
  </script>
</body>
</html>
